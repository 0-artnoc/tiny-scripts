#!/bin/bash

readonly program="$(basename "${0}")"

# This script depends on imagemagick and ffmpeg for the conversion
# ----------------------------------------------------------------
depends_on() {
  if [[ ! $(which "${1}") ]]; then
    echo -e >&2 "\n$(tput setaf 1)This script requires ${1}. Please install it first.$(tput sgr0)\n"
    exit 1
  fi
}

depends_on convert
depends_on ffmpeg

# Instructions on how to use the script
# Shown when no arguments are given
# -------------------------------------
usage() {
  echo "usage: ${program} <input_file> [<output_file>]"
}

if [[ -z ${1} ]]; then
  usage
  exit 1
fi

# Make gif next to original video, if no output name given
# --------------------------------------------------------
input_file="${1}"

if [[ -z ${2} ]]; then
  input_file_name=$(basename "${input_file}")
  input_file_no_extension=${input_file_name%.*}
  input_file_dir=$(dirname "${input_file}")
  output_file="${input_file_dir}/${input_file_no_extension}.gif"
else
  output_file="${2}"
fi


# Make the animated gif
# ---------------------
ffmpeg -i "${input_file}" -r 10 -f image2pipe -vcodec ppm - | convert -dispose Background - -layers Optimize "${output_file}"
